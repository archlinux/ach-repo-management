---
#
# SPDX-License-Identifier: GPL-3.0-or-later

default:
  image: "archlinux:latest"

stages:
  - test
  - webhook

.test:
  stage: test
  before_script:
    - printf "[multilib]\nInclude = /etc/pacman.d/mirrorlist\n" >> /etc/pacman.conf
    - pacman --noconfirm -Fyy
    - pacman --noconfirm -Syyu --needed base-devel git python-poetry python-tox

linter:
  extends: .test
  script:
    - tox -e linter

coverage:
  extends: .test
  script:
    - tox -e coverage
  coverage: '/TOTAL.*\s([.\d]+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: .tox/coverage.xml
      junit: junit-report.xml

docs:
  extends: .test
  script:
    - tox -e docs

integration:
  extends: .test
  script:
    - tox -e integration

readthedocs:
  stage: webhook
  script:
    - pacman --noconfirm -Syu --needed curl
    - curl -X POST -d "token=${READTHEDOCS_TOKEN}" https://readthedocs.org/api/v2/webhook/repod/${READTHEDOCS_PROJECT_ID}/
  only:
    - master@archlinux/repod
